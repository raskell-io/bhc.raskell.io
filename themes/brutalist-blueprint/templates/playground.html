{% extends "base.html" %}

{% block title %}Playground - {{ config.title }}{% endblock %}

{% block content %}
<!-- Side rails -->
<div class="landing-rails">
    <div class="landing-rail landing-rail--left"></div>
    <div class="landing-rail landing-rail--right"></div>
</div>

<div class="landing">
    <div class="landing__container">

        <!-- Page Hero Section -->
        <section class="page-hero" data-section="hero" data-page-slug="playground">
            <canvas id="page-hero-canvas" class="page-hero__canvas"></canvas>
            <div class="page-hero__content">
                <span class="page-hero__label">[ PLAYGROUND ]</span>
            </div>
        </section>

        <!-- Playground Section -->
        <section class="content-section content-section--page playground-section" data-section="playground">
            <div class="content-section__frame">
                <div class="playground">
                    <!-- Status bar -->
                    <div class="playground__status" id="playground-status">
                        <span class="playground__status-text">Loading BHC interpreter...</span>
                        <span class="playground__status-indicator playground__status-indicator--loading"></span>
                    </div>

                    <!-- Editor area -->
                    <div class="playground__editor-container">
                        <div class="playground__editor-header">
                            <span class="playground__editor-label">Main.hs</span>
                            <div class="playground__editor-actions">
                                <select id="playground-profile" class="playground__select">
                                    <option value="default">Default (Lazy)</option>
                                    <option value="numeric">Numeric (Strict)</option>
                                </select>
                                <button id="playground-run" class="playground__button playground__button--run" disabled>
                                    <span class="playground__button-icon">▶</span>
                                    Run
                                </button>
                                <button id="playground-check" class="playground__button playground__button--check" disabled>
                                    Check
                                </button>
                            </div>
                        </div>
                        <textarea id="playground-editor" class="playground__editor" spellcheck="false">-- Try some Haskell!
-- Examples:

-- Simple arithmetic
-- main = 2 + 3 * 4

-- Let expressions
-- main = let x = 10 in x + 5

-- Lists
-- main = [1, 2, 3, 4, 5]

-- Recursive functions
-- main = let factorial n = if n <= 1 then 1 else n * factorial (n - 1) in factorial 5

-- Fibonacci
main = let fib n = if n <= 1 then n else fib (n - 1) + fib (n - 2) in fib 10</textarea>
                    </div>

                    <!-- Output area -->
                    <div class="playground__output-container">
                        <div class="playground__output-header">
                            <span class="playground__output-label">Output</span>
                            <button id="playground-clear" class="playground__button playground__button--small">Clear</button>
                        </div>
                        <div id="playground-output" class="playground__output">
                            <span class="playground__output-placeholder">Press Run to execute your code</span>
                        </div>
                    </div>

                    <!-- Examples -->
                    <div class="playground__examples">
                        <span class="playground__examples-label">Examples:</span>
                        <button class="playground__example" data-code="main = 42">Literal</button>
                        <button class="playground__example" data-code="main = 2 + 3 * 4">Arithmetic</button>
                        <button class="playground__example" data-code="main = let x = 10 in x * x">Let</button>
                        <button class="playground__example" data-code="main = [1, 2, 3, 4, 5]">List</button>
                        <button class="playground__example" data-code="main = let factorial n = if n <= 1 then 1 else n * factorial (n - 1) in factorial 10">Factorial</button>
                        <button class="playground__example" data-code="main = let fib n = if n <= 1 then n else fib (n - 1) + fib (n - 2) in fib 15">Fibonacci</button>
                    </div>
                </div>

                <!-- Info section -->
                <div class="content-section__body content-section__body--page playground-info">
                    {{ page.content | safe }}
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer" data-section="footer">
            <canvas id="wireframe-footer-canvas" class="footer__canvas"></canvas>
            <canvas id="lissajous-canvas" class="footer__canvas footer__canvas--corners"></canvas>
            <div class="footer__container">
                <div class="footer__grid">
                    <div class="footer__brand">
                        <a href="/" class="footer__brand-name">{{ config.title }}</a>
                        {% if config.extra.product.footer_tagline %}
                        <span class="footer__brand-tagline">{{ config.extra.product.footer_tagline }}</span>
                        {% endif %}
                    </div>

                    {% for group in config.extra.product.footer_links %}
                    <div class="footer__column">
                        <h4 class="footer__column-title">{{ group.title }}</h4>
                        <div class="footer__links">
                            {% for link in group.links %}
                            <a href="{{ link.url }}" class="footer__link" {% if link.external %}target="_blank" rel="noopener noreferrer"{% endif %}>
                                {{ link.text }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="footer__bottom">
                    <span class="footer__copyright">{{ config.extra.product.footer_note | safe }}</span>
                    <div class="footer__social">
                        {% if config.extra.social.github %}
                        <a href="{{ config.extra.social.github }}" class="footer__social-link" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                        </a>
                        {% endif %}
                        {% if config.extra.social.twitter %}
                        <a href="{{ config.extra.social.twitter }}" class="footer__social-link" target="_blank" rel="noopener noreferrer" aria-label="Twitter">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </footer>

    </div>
</div>

<style>
/* Playground Styles */
.playground-section {
    padding: 0;
}

.playground {
    background: var(--color-bg-secondary, #0a0a0a);
    border: 1px solid var(--color-border, #333);
    margin-bottom: 2rem;
}

.playground__status {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    background: var(--color-bg-tertiary, #111);
    border-bottom: 1px solid var(--color-border, #333);
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-secondary, #888);
}

.playground__status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #666;
}

.playground__status-indicator--loading {
    background: #f59e0b;
    animation: pulse 1s ease-in-out infinite;
}

.playground__status-indicator--ready {
    background: #22c55e;
}

.playground__status-indicator--error {
    background: #ef4444;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.playground__editor-container {
    border-bottom: 1px solid var(--color-border, #333);
}

.playground__editor-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    background: var(--color-bg-tertiary, #111);
    border-bottom: 1px solid var(--color-border, #333);
}

.playground__editor-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-secondary, #888);
}

.playground__editor-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.playground__select {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
    background: var(--color-bg-secondary, #0a0a0a);
    border: 1px solid var(--color-border, #333);
    color: var(--color-text, #fff);
    cursor: pointer;
}

.playground__button {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
    background: var(--color-bg-secondary, #0a0a0a);
    border: 1px solid var(--color-border, #333);
    color: var(--color-text, #fff);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    transition: all 0.15s ease;
}

.playground__button:hover:not(:disabled) {
    background: var(--color-bg-tertiary, #111);
    border-color: var(--color-accent, #3b82f6);
}

.playground__button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.playground__button--run {
    background: var(--color-accent, #3b82f6);
    border-color: var(--color-accent, #3b82f6);
}

.playground__button--run:hover:not(:disabled) {
    background: #2563eb;
}

.playground__button--small {
    padding: 0.25rem 0.5rem;
}

.playground__button-icon {
    font-size: 0.625rem;
}

.playground__editor {
    width: 100%;
    min-height: 300px;
    padding: 1rem;
    background: var(--color-bg-secondary, #0a0a0a);
    border: none;
    color: var(--color-text, #fff);
    font-family: var(--font-mono);
    font-size: 0.875rem;
    line-height: 1.5;
    resize: vertical;
}

.playground__editor:focus {
    outline: none;
}

.playground__output-container {
    border-bottom: 1px solid var(--color-border, #333);
}

.playground__output-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    background: var(--color-bg-tertiary, #111);
    border-bottom: 1px solid var(--color-border, #333);
}

.playground__output-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-secondary, #888);
}

.playground__output {
    min-height: 100px;
    max-height: 300px;
    overflow-y: auto;
    padding: 1rem;
    font-family: var(--font-mono);
    font-size: 0.875rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
}

.playground__output-placeholder {
    color: var(--color-text-secondary, #666);
    font-style: italic;
}

.playground__output--success {
    color: #22c55e;
}

.playground__output--error {
    color: #ef4444;
}

.playground__examples {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    flex-wrap: wrap;
}

.playground__examples-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-secondary, #888);
}

.playground__example {
    font-family: var(--font-mono);
    font-size: 0.625rem;
    padding: 0.25rem 0.5rem;
    background: transparent;
    border: 1px solid var(--color-border, #333);
    color: var(--color-text-secondary, #888);
    cursor: pointer;
    transition: all 0.15s ease;
}

.playground__example:hover {
    border-color: var(--color-accent, #3b82f6);
    color: var(--color-text, #fff);
}

.playground-info {
    margin-top: 2rem;
}

.playground-info h2 {
    margin-top: 2rem;
}

.playground-info h2:first-child {
    margin-top: 0;
}
</style>

<script type="module">
// Playground JavaScript
let bhc = null;
let isReady = false;

const statusEl = document.getElementById('playground-status');
const statusTextEl = statusEl.querySelector('.playground__status-text');
const statusIndicatorEl = statusEl.querySelector('.playground__status-indicator');
const editorEl = document.getElementById('playground-editor');
const outputEl = document.getElementById('playground-output');
const runBtn = document.getElementById('playground-run');
const checkBtn = document.getElementById('playground-check');
const clearBtn = document.getElementById('playground-clear');
const profileSelect = document.getElementById('playground-profile');
const exampleBtns = document.querySelectorAll('.playground__example');

function setStatus(text, state) {
    statusTextEl.textContent = text;
    statusIndicatorEl.className = 'playground__status-indicator';
    if (state) {
        statusIndicatorEl.classList.add(`playground__status-indicator--${state}`);
    }
}

function setOutput(text, isError = false) {
    outputEl.innerHTML = '';
    outputEl.className = 'playground__output';
    if (isError) {
        outputEl.classList.add('playground__output--error');
    } else {
        outputEl.classList.add('playground__output--success');
    }
    outputEl.textContent = text;
}

function clearOutput() {
    outputEl.innerHTML = '<span class="playground__output-placeholder">Press Run to execute your code</span>';
    outputEl.className = 'playground__output';
}

async function initPlayground() {
    try {
        // Dynamic import of the WASM module
        const module = await import('/playground/bhc_playground.js');
        await module.default();
        bhc = module;
        isReady = true;

        setStatus('BHC interpreter ready', 'ready');
        runBtn.disabled = false;
        checkBtn.disabled = false;
    } catch (error) {
        console.error('Failed to load BHC:', error);
        setStatus('Failed to load interpreter: ' + error.message, 'error');
    }
}

function runCode() {
    if (!isReady) return;

    const source = editorEl.value;
    const profile = profileSelect.value;

    setStatus('Running...', 'loading');

    try {
        let resultJson;
        if (profile === 'numeric') {
            resultJson = bhc.run_haskell_numeric(source);
        } else {
            resultJson = bhc.run_haskell(source);
        }

        const result = JSON.parse(resultJson);

        if (result.success) {
            setOutput(result.output.display);
            setStatus('Execution complete', 'ready');
        } else {
            const err = result.error;
            let errorMsg = err.message;
            if (err.line) {
                errorMsg = `Line ${err.line}: ${errorMsg}`;
            }
            setOutput(`Error: ${errorMsg}`, true);
            setStatus(`${err.category} error`, 'error');
        }
    } catch (error) {
        setOutput(`Internal error: ${error.message}`, true);
        setStatus('Error', 'error');
    }
}

function checkCode() {
    if (!isReady) return;

    const source = editorEl.value;

    setStatus('Checking...', 'loading');

    try {
        const resultJson = bhc.check_haskell(source);
        const result = JSON.parse(resultJson);

        if (result.success) {
            setOutput('No errors found');
            setStatus('Check complete', 'ready');
        } else {
            const err = result.error;
            let errorMsg = err.message;
            if (err.line) {
                errorMsg = `Line ${err.line}: ${errorMsg}`;
            }
            setOutput(`Error: ${errorMsg}`, true);
            setStatus(`${err.category} error`, 'error');
        }
    } catch (error) {
        setOutput(`Internal error: ${error.message}`, true);
        setStatus('Error', 'error');
    }
}

// Event listeners
runBtn.addEventListener('click', runCode);
checkBtn.addEventListener('click', checkCode);
clearBtn.addEventListener('click', clearOutput);

// Keyboard shortcut: Ctrl/Cmd + Enter to run
editorEl.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        runCode();
    }
});

// Example buttons
exampleBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        editorEl.value = btn.dataset.code;
        clearOutput();
    });
});

// Initialize
initPlayground();
</script>

<script>
// Rotating Möbius strip wireframe
function drawPlayground() {
    const canvas = document.getElementById('page-hero-canvas');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const parent = canvas.parentElement;

    function resize() {
        canvas.width = parent.offsetWidth;
        canvas.height = parent.offsetHeight;
    }
    resize();
    window.addEventListener('resize', resize);

    let time = 0;
    const targetFPS = 30;
    const frameInterval = 1000 / targetFPS;
    let lastFrameTime = 0;

    // Möbius strip parametric equations
    // x = (1 + v/2 * cos(u/2)) * cos(u)
    // y = (1 + v/2 * cos(u/2)) * sin(u)
    // z = v/2 * sin(u/2)
    function mobiusPoint(u, v) {
        const halfU = u / 2;
        const cosHalfU = Math.cos(halfU);
        const sinHalfU = Math.sin(halfU);
        const cosU = Math.cos(u);
        const sinU = Math.sin(u);
        const r = 1 + (v / 2) * cosHalfU;
        return {
            x: r * cosU,
            y: r * sinU,
            z: (v / 2) * sinHalfU
        };
    }

    // 3D rotation matrices
    function rotateX(p, angle) {
        const cos = Math.cos(angle);
        const sin = Math.sin(angle);
        return {
            x: p.x,
            y: p.y * cos - p.z * sin,
            z: p.y * sin + p.z * cos
        };
    }

    function rotateY(p, angle) {
        const cos = Math.cos(angle);
        const sin = Math.sin(angle);
        return {
            x: p.x * cos + p.z * sin,
            y: p.y,
            z: -p.x * sin + p.z * cos
        };
    }

    function rotateZ(p, angle) {
        const cos = Math.cos(angle);
        const sin = Math.sin(angle);
        return {
            x: p.x * cos - p.y * sin,
            y: p.x * sin + p.y * cos,
            z: p.z
        };
    }

    // Project 3D to 2D with perspective
    function project(p, w, h, scale, distance) {
        const factor = distance / (distance + p.z);
        return {
            x: w / 2 + p.x * scale * factor,
            y: h / 2 + p.y * scale * factor,
            z: p.z
        };
    }

    // Generate strip mesh
    const uSteps = 48;
    const vSteps = 6;
    const strip = [];

    for (let i = 0; i <= uSteps; i++) {
        const row = [];
        const u = (i / uSteps) * Math.PI * 2;
        for (let j = 0; j <= vSteps; j++) {
            const v = (j / vSteps) * 2 - 1; // -1 to 1
            row.push(mobiusPoint(u, v * 0.6)); // 0.6 controls strip width
        }
        strip.push(row);
    }

    function render(currentTime) {
        requestAnimationFrame(render);

        if (currentTime - lastFrameTime < frameInterval) return;
        lastFrameTime = currentTime;

        const w = canvas.width;
        const h = canvas.height;
        const scale = Math.min(w, h) * 0.4;
        const distance = 4;

        // Clear with fade for slight trail effect
        ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
        ctx.fillRect(0, 0, w, h);

        // Rotation angles
        const rotX = time * 0.3;
        const rotY = time * 0.5;
        const rotZ = time * 0.2;

        // Transform and project all points
        const projected = [];
        for (let i = 0; i <= uSteps; i++) {
            const row = [];
            for (let j = 0; j <= vSteps; j++) {
                let p = strip[i][j];
                p = rotateX(p, rotX);
                p = rotateY(p, rotY);
                p = rotateZ(p, rotZ);
                row.push(project(p, w, h, scale, distance));
            }
            projected.push(row);
        }

        // Draw wireframe
        ctx.strokeStyle = 'rgba(59, 130, 246, 0.6)';
        ctx.lineWidth = 1;

        // Draw lines along u (around the strip)
        for (let j = 0; j <= vSteps; j++) {
            ctx.beginPath();
            for (let i = 0; i <= uSteps; i++) {
                const p = projected[i][j];
                if (i === 0) {
                    ctx.moveTo(p.x, p.y);
                } else {
                    ctx.lineTo(p.x, p.y);
                }
            }
            ctx.stroke();
        }

        // Draw lines along v (across the strip width)
        for (let i = 0; i <= uSteps; i += 2) {
            ctx.beginPath();
            for (let j = 0; j <= vSteps; j++) {
                const p = projected[i][j];
                if (j === 0) {
                    ctx.moveTo(p.x, p.y);
                } else {
                    ctx.lineTo(p.x, p.y);
                }
            }
            ctx.stroke();
        }

        // Draw edge highlights
        ctx.strokeStyle = 'rgba(59, 130, 246, 0.9)';
        ctx.lineWidth = 1.5;

        // Top edge
        ctx.beginPath();
        for (let i = 0; i <= uSteps; i++) {
            const p = projected[i][0];
            if (i === 0) ctx.moveTo(p.x, p.y);
            else ctx.lineTo(p.x, p.y);
        }
        ctx.stroke();

        // Bottom edge
        ctx.beginPath();
        for (let i = 0; i <= uSteps; i++) {
            const p = projected[i][vSteps];
            if (i === 0) ctx.moveTo(p.x, p.y);
            else ctx.lineTo(p.x, p.y);
        }
        ctx.stroke();

        time += 0.02;
    }

    requestAnimationFrame(render);
}

drawPlayground();
</script>
{% endblock %}
